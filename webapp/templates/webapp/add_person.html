{% extends "base_generic.html" %}
{% load static %}

{% block content %}
  <div class="person-form">
    <h1>Add Person</h1>
    <hr>
    <form action="" method="POST">
      {% csrf_token %}
      <table>
        {{ name_form.as_table }}
      </table>
      <div id="events-container">
        <script>
            let eventsContainer;
            // declare elements in order to maintain their state
            let birthEventToggle;
            let deathEventToggle;

            // delay assignment until other elements are loaded
            $(document).ready(function () {
                eventsContainer = document.getElementById("events-container");
                addEventToggle(eventsContainer, "Birth", 0);
                addEventToggle(eventsContainer, "Death", 1);
            });

            function addEventToggle(container, eventType, pos) {
                let eventContainer = document.createElement("div");
                eventContainer.classList.add("event-container");
                container.insertBefore(eventContainer, container.children[pos]);

                let eventToggleContainer = document.createElement("div");
                eventToggleContainer.classList.add("event-toggle-container", "event-toggle-add");
                eventContainer.appendChild(eventToggleContainer);

                let eventToggle = document.createElement("p");
                eventToggle.innerText = "+ Add new " + eventType + " event";
                eventToggle.classList.add("event-toggle");
                eventToggleContainer.appendChild(eventToggle);

                let eventBody = document.createElement("div");
                eventBody.classList.add("event-body");
                eventContainer.appendChild(eventBody);
                initEventToggle(eventToggle, eventType);
            }

            function initEventToggle(element, eventType) {
                element.toggled = false;
                element.event = undefined;
                element.eventType = eventType;
                element.addEventListener('click', event => toggleEvent(event.target));
                return element;
            }

            function toggleEvent(element) {
                if (!element.toggled) {
                    element.innerHTML = "- Remove " + element.eventType.toLowerCase() + " event";
                    element.parentElement.classList.remove("event-toggle-add");
                    element.parentElement.classList.add("event-toggle-remove");
                    addEventForm(element);
                } else {
                    element.innerHTML = "+ Add new " + element.eventType.toLowerCase() + " event";
                    element.parentElement.classList.remove("event-toggle-remove");
                    element.parentElement.classList.add("event-toggle-add");
                    if (element.event !== undefined) {
                        $(element.event).remove();
                    }
                }
                element.toggled = !element.toggled;
            }

            function addEventForm(element) {
                let container = element.parentElement.parentElement.getElementsByClassName("event-body")[0];
                let eventDiv = document.createElement("div");
                let header = `<h3>` + element.eventType + `</h3>`
                let eventFormTable = `<table>{{ event_form.as_table|escape }}</table>\n`;
                eventDiv.innerHTML = header + eventFormTable;
                let typeEl = eventDiv.querySelector("#id_type")
                typeEl.value = element.eventType;
                typeEl.disabled = true;
                container.appendChild(eventDiv);
                element.event = eventDiv
            }

            function genId() {
                return '_' + Math.random().toString(36).substring(2, 12);
            }
        </script>
        <div class="reveal-toggle-container">
          <p id="reveal-toggle" class="group-toggle">+ Show extra event options</p>
        </div>
        <div id="more-events" hidden>
          {% for event_type in event_types %}
            <div class="event-container">
              <p id="add-{{ event_type }}" class="event-toggle event-toggle-add">+ Add new {{ event_type }} event</p>
            </div>
          {% endfor %}
        </div>

        <script>
            let showMoreEventsToggle = document.getElementById("reveal-toggle");
            let moreEvents = document.getElementById("more-events");
            showMoreEventsToggle.toggled = false;
            showMoreEventsToggle.addEventListener('click', toggleMoreEventTypes);

            function toggleMoreEventTypes() {
                if (!showMoreEventsToggle.toggled) {
                    showMoreEventsToggle.innerHTML = "- Hide extra event options";
                    moreEvents.hidden = false;
                } else {
                    showMoreEventsToggle.innerHTML = "+ Show extra event options";
                    moreEvents.hidden = true;
                }
                showMoreEventsToggle.toggled = !showMoreEventsToggle.toggled;
            }
        </script>
      </div>
      <table>
        {{ person_form.as_table }}
      </table>
      <hr>
      <h2> Alternate Names </h2>
      <table class="table">
        {{ alt_name_formset.management_form }}

        {% for form in alt_name_formset.forms %}
          {% if forloop.first %}
            <thead>
            <tr>
              {% for field in form.visible_fields %}
                <th>{{ field.label_tag }}</th>
              {% endfor %}
            </tr>
            </thead>
          {% endif %}
          <tr class="{% cycle 'row1' 'row2' %} formset_row">
            {% for field in form.visible_fields %}
              <td>
                {% if forloop.first %}
                  {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}
                {% endif %}
                {{ field.errors.as_ul }}
                {{ field }}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </table>
      <input type="submit" value="Submit"/>
    </form>
  </div>
  <!-- Include formset plugin - including jQuery dependency -->
  <script src="{% static 'webapp/js/jquery.formset.js' %}"></script>
  <script type="text/javascript">
      $(document).ready(function () {
          $('tr.formset_row').formset({
              addText: 'add name',
              deleteText: 'remove',
              prefix: 'alternate_name'
          });
      });
  </script>
{% endblock %}